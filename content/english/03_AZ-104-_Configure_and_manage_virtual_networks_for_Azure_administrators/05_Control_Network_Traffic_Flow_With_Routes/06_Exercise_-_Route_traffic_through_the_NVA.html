<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Exercise - Route traffic through the NVA - Training | Microsoft Learn</title>
<style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 30px 20px;
            color: #333;
            background-color: #fff;
        }
        
        h1, h2, h3, h4, h5, h6 {
            color: #0078d4;
            margin-top: 2em;
            margin-bottom: 1em;
            font-weight: 600;
        }
        
        h1 { 
            border-bottom: 3px solid #0078d4; 
            padding-bottom: 15px; 
            font-size: 2.2em;
            margin-bottom: 1.5em;
        }
        
        h2 { 
            font-size: 1.6em; 
            border-left: 4px solid #0078d4;
            padding-left: 15px;
        }
        
        h3 { font-size: 1.3em; }
        h4 { font-size: 1.1em; }
        
        p {
            margin: 16px 0;
            text-align: justify;
            line-height: 1.7;
        }
        
        ul, ol {
            margin: 20px 0;
            padding-left: 30px;
        }
        
        li {
            margin: 10px 0;
            line-height: 1.6;
        }
        
        code {
            background-color: #f6f8fa;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            color: #d73a49;
        }
        
        pre {
            background-color: #f6f8fa;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            border-left: 4px solid #0078d4;
            margin: 20px 0;
        }
        
        pre code {
            background: none;
            padding: 0;
            color: #333;
        }
        
        blockquote {
            border-left: 4px solid #0078d4;
            padding: 20px;
            margin: 20px 0;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-style: italic;
        }
        
        .source-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 5px solid #2196f3;
            font-size: 0.9em;
        }
        
        .source-info h2 {
            margin-top: 0;
            color: #1976d2;
            font-size: 1.2em;
        }
        
        .translation-placeholder {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            padding: 20px;
            border-radius: 8px;
            margin-top: 40px;
            border-left: 5px solid #ff9800;
        }
        
        .translation-placeholder h2 {
            margin-top: 0;
            color: #f57c00;
            font-size: 1.2em;
        }
        
        img { 
            max-width: 100%; 
            height: auto; 
            margin: 25px 0;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        table { 
            border-collapse: collapse; 
            width: 100%; 
            margin: 25px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        th, td { 
            border: 1px solid #ddd; 
            padding: 15px; 
            text-align: left; 
        }
        
        th { 
            background-color: #f5f5f5; 
            font-weight: bold;
            color: #0078d4;
        }
        
        .highlight {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
        }
        
        strong {
            color: #0078d4;
            font-weight: 600;
        }
        
        a {
            color: #0078d4;
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
<div class="source-info">
<h2>ðŸ“š Course Information</h2>
<p><strong>Unit:</strong> Exercise - Route traffic through the NVA</p>
<p><strong>Source:</strong> <a href="https://learn.microsoft.com/en-us/training/modules/control-network-traffic-flow-with-routes/6-exercise-route-traffic-through-nva/?ns-enrollment-type=learningpath&amp;ns-enrollment-id=learn.az-104-manage-virtual-networks" target="_blank">https://learn.microsoft.com/en-us/training/modules/control-network-traffic-flow-with-routes/6-exercise-route-traffic-through-nva/?ns-enrollment-type=learningpath&amp;ns-enrollment-id=learn.az-104-manage-virtual-networks</a></p>
<p><strong>Course:</strong> AZ-104: Microsoft Azure Administrator</p>
</div>
<div class="main-content">
<div aria-hidden="false" id="module-unit-content">
<p>
  Now that you've created the network virtual appliance (NVA) and virtual machines (VMs), you'll route the traffic through the NVA.
 </p>
<h2 id="create-public-and-private-virtual-machines">
  Create public and private virtual machines
 </h2>
<p>
  The next steps deploy a VM into the public and private subnets.
 </p>
<ol>
<li>
<p>
    Open the Cloud Shell editor and create a file named cloud-init.txt.
   </p>
<pre class="has-inner-focus"><code class="lang-bash" data-author-content="code cloud-init.txt
"><span>code cloud-init.txt
</span></code></pre>
</li>
<li>
<p>
    Add the following configuration information to the file. With this configuration, the
    <code>
     inetutils-traceroute
    </code>
    package is installed when you create a new VM. This package contains the
    <code>
     traceroute
    </code>
    utility that you'll use later in this exercise.
   </p>
<pre class="has-inner-focus"><code class="lang-Text" data-author-content="#cloud-config
package_upgrade: true
packages:
   - inetutils-traceroute
">#cloud-config
package_upgrade: true
packages:
   - inetutils-traceroute
</code></pre>
</li>
<li>
<p>
    Press
    <kbd>
     Ctrl+S
    </kbd>
    to save the file, and then press
    <kbd>
     Ctrl+Q
    </kbd>
    to close the editor.
   </p>
</li>
<li>
<p>
    In Cloud Shell, run the following command to create the
    <strong>
     public
    </strong>
    VM. Replace
    <code>
     &lt;password&gt;
    </code>
    with a suitable password for the
    <strong>
     azureuser
    </strong>
    account.
   </p>
<pre class="has-inner-focus"><code class="lang-azurecli" data-author-content='az vm create \
    --resource-group "&lt;rgn&gt;[sandbox resource group name]&lt;/rgn&gt;" \
    --name public \
    --vnet-name vnet \
    --subnet publicsubnet \
    --image Ubuntu2204 \
    --admin-username azureuser \
    --no-wait \
    --custom-data cloud-init.txt \
    --admin-password &lt;password&gt;
'><span><span class="hljs-keyword">az vm create </span>\
    <span class="hljs-parameter">--resource-group</span> <span class="hljs-string">"[sandbox resource group name]"</span> \
    <span class="hljs-parameter">--name</span> public \
    <span class="hljs-parameter">--vnet-name</span> vnet \
    <span class="hljs-parameter">--subnet</span> publicsubnet \
    <span class="hljs-parameter">--image</span> Ubuntu2204 \
    <span class="hljs-parameter">--admin-username</span> azureuser \
    <span class="hljs-parameter">--no-wait</span> \
    <span class="hljs-parameter">--custom-data</span> cloud<span class="hljs-parameter">-init</span>.txt \
    <span class="hljs-parameter">--admin-password</span> <span class="hljs-string">&lt;password&gt;</span>
</span></code></pre>
</li>
<li>
<p>
    Run the following command to create the
    <strong>
     private
    </strong>
    VM. Replace
    <code>
     &lt;password&gt;
    </code>
    with a suitable password.
   </p>
<pre class="has-inner-focus"><code class="lang-azurecli" data-author-content='az vm create \
    --resource-group "&lt;rgn&gt;[sandbox resource group name]&lt;/rgn&gt;" \
    --name private \
    --vnet-name vnet \
    --subnet privatesubnet \
    --image Ubuntu2204 \
    --admin-username azureuser \
    --no-wait \
    --custom-data cloud-init.txt \
    --admin-password &lt;password&gt;
'><span><span class="hljs-keyword">az vm create </span>\
    <span class="hljs-parameter">--resource-group</span> <span class="hljs-string">"[sandbox resource group name]"</span> \
    <span class="hljs-parameter">--name</span> private \
    <span class="hljs-parameter">--vnet-name</span> vnet \
    <span class="hljs-parameter">--subnet</span> privatesubnet \
    <span class="hljs-parameter">--image</span> Ubuntu2204 \
    <span class="hljs-parameter">--admin-username</span> azureuser \
    <span class="hljs-parameter">--no-wait</span> \
    <span class="hljs-parameter">--custom-data</span> cloud<span class="hljs-parameter">-init</span>.txt \
    <span class="hljs-parameter">--admin-password</span> <span class="hljs-string">&lt;password&gt;</span>
</span></code></pre>
</li>
<li>
<p>
    Run the following Linux
    <code>
     watch
    </code>
    command to check that the VMs are running. The
    <code>
     watch
    </code>
    command periodically runs the
    <code>
     az vm list
    </code>
    command so that you can monitor the progress of the VMs.
   </p>
<pre aria-label="Horizontally scrollable code" class="has-inner-focus" role="group" tabindex="0"><code class="lang-bash" data-author-content="watch -d -n 5 &quot;az vm list \
    --resource-group &quot;&lt;rgn&gt;[sandbox resource group name]&lt;/rgn&gt;&quot; \
    --show-details \
    --query '[*].{Name:name, ProvisioningState:provisioningState, PowerState:powerState}' \
    --output table&quot;
"><span>watch -d -n 5 <span class="hljs-string">"az vm list \
    --resource-group "</span>[sandbox resource group name]<span class="hljs-string">" \
    --show-details \
    --query '[*].{Name:name, ProvisioningState:provisioningState, PowerState:powerState}' \
    --output table"</span>
</span></code></pre>
<p>
    A
    <strong>
     ProvisioningState
    </strong>
    value of "Succeeded" and a
    <strong>
     PowerState
    </strong>
    value of "VM running" indicate a successful deployment. When all three VMs are running, you're ready to move on. Press
    <kbd>
     Ctrl-C
    </kbd>
    to stop the command and continue with the exercise.
   </p>
</li>
<li>
<p>
    Run the following command to save the public IP address of the
    <strong>
     public
    </strong>
    VM to a variable named
    <code>
     PUBLICIP
    </code>
    :
   </p>
<pre aria-label="Horizontally scrollable code" class="has-inner-focus" role="group" tabindex="0"><code class="lang-azurecli" data-author-content='PUBLICIP="$(az vm list-ip-addresses \
    --resource-group "&lt;rgn&gt;[sandbox resource group name]&lt;/rgn&gt;" \
    --name public \
    --query "[].virtualMachine.network.publicIpAddresses[*].ipAddress" \
    --output tsv)"

echo $PUBLICIP
'><span>PUBLICIP=<span class="hljs-string">"<span class="hljs-variable">$(az vm list-ip-addresses \
    --resource-group "[sandbox resource group name]" \
    --name public \
    --query "[].virtualMachine.network.publicIpAddresses[*].ipAddress" \
    --output tsv)</span>"</span>

echo <span class="hljs-variable">$PUBLICIP</span>
</span></code></pre>
</li>
<li>
<p>
    Run the following command to save the public IP address of the
    <strong>
     private
    </strong>
    VM to a variable named
    <code>
     PRIVATEIP
    </code>
    :
   </p>
<pre aria-label="Horizontally scrollable code" class="has-inner-focus" role="group" tabindex="0"><code class="lang-azurecli" data-author-content='PRIVATEIP="$(az vm list-ip-addresses \
    --resource-group "&lt;rgn&gt;[sandbox resource group name]&lt;/rgn&gt;" \
    --name private \
    --query "[].virtualMachine.network.publicIpAddresses[*].ipAddress" \
    --output tsv)"

echo $PRIVATEIP
'><span>PRIVATEIP=<span class="hljs-string">"<span class="hljs-variable">$(az vm list-ip-addresses \
    --resource-group "[sandbox resource group name]" \
    --name private \
    --query "[].virtualMachine.network.publicIpAddresses[*].ipAddress" \
    --output tsv)</span>"</span>

echo <span class="hljs-variable">$PRIVATEIP</span>
</span></code></pre>
</li>
</ol>
<h2 id="test-traffic-routing-through-the-network-virtual-appliance">
  Test traffic routing through the network virtual appliance
 </h2>
<p>
  The final steps use the Linux
  <code>
   traceroute
  </code>
  utility to show how traffic is routed. You'll use the
  <code>
   ssh
  </code>
  command to run
  <code>
   traceroute
  </code>
  on each VM. The first test shows the route taken by ICMP packets sent from the
  <strong>
   public
  </strong>
  VM to the
  <strong>
   private
  </strong>
  VM. The second test shows the route taken by ICMP packets sent from the
  <strong>
   private
  </strong>
  VM to the
  <strong>
   public
  </strong>
  VM.
 </p>
<ol>
<li>
<p>
    Run the following command to trace the route from
    <strong>
     public
    </strong>
    to
    <strong>
     private
    </strong>
    . When prompted, enter the password for the
    <strong>
     azureuser
    </strong>
    account that you specified earlier.
   </p>
<pre aria-label="Horizontally scrollable code" class="has-inner-focus" role="group" tabindex="0"><code class="lang-bash" data-author-content="ssh -t -o StrictHostKeyChecking=no azureuser@$PUBLICIP 'traceroute private --type=icmp; exit'
"><span>ssh -t -o StrictHostKeyChecking=no azureuser@<span class="hljs-variable">$PUBLICIP</span> <span class="hljs-string">'traceroute private --type=icmp; exit'</span>
</span></code></pre>
<p>
    If you receive the error message
    <code>
     bash: traceroute: command not found
    </code>
    , wait a minute and retry the command. The automated installation of
    <code>
     traceroute
    </code>
    can take a minute or two after VM deployment. After the command succeeds, the output should look similar to the following example:
   </p>
<pre aria-label="Horizontally scrollable code" class="has-inner-focus" role="group" tabindex="0"><code class="lang-Text" data-author-content="traceroute to private.kzffavtrkpeulburui2lgywxwg.gx.internal.cloudapp.net (10.0.1.4), 64 hops max
1   10.0.2.4  0.710ms  0.410ms  0.536ms
2   10.0.1.4  0.966ms  0.981ms  1.268ms
Connection to 52.165.151.216 closed.
">traceroute to private.kzffavtrkpeulburui2lgywxwg.gx.internal.cloudapp.net (10.0.1.4), 64 hops max
1   10.0.2.4  0.710ms  0.410ms  0.536ms
2   10.0.1.4  0.966ms  0.981ms  1.268ms
Connection to 52.165.151.216 closed.
</code></pre>
<p>
    Notice that the first hop is to 10.0.2.4. This address is the private IP address of
    <strong>
     nva
    </strong>
    . The second hop is to 10.0.1.4, the address of
    <strong>
     private
    </strong>
    . In the first exercise, you added this route to theÂ route table and linked the table to the
    <strong>
     publicsubnet
    </strong>
    subnet. So now all traffic from
    <strong>
     public
    </strong>
    to
    <strong>
     private
    </strong>
    is routed through the NVA.
   </p>
</li>
<li>
<p>
    Run the following command to trace the route from
    <strong>
     private
    </strong>
    to
    <strong>
     public
    </strong>
    . When prompted, enter the password for the
    <strong>
     azureuser
    </strong>
    account.
   </p>
<pre aria-label="Horizontally scrollable code" class="has-inner-focus" role="group" tabindex="0"><code class="lang-bash" data-author-content="ssh -t -o StrictHostKeyChecking=no azureuser@$PRIVATEIP 'traceroute public --type=icmp; exit'
"><span>ssh -t -o StrictHostKeyChecking=no azureuser@<span class="hljs-variable">$PRIVATEIP</span> <span class="hljs-string">'traceroute public --type=icmp; exit'</span>
</span></code></pre>
<p>
    You should see the traffic go directly to
    <strong>
     public
    </strong>
    (10.0.0.4) and not through the NVA, as shown in the following command output.
   </p>
<pre aria-label="Horizontally scrollable code" class="has-inner-focus" role="group" tabindex="0"><code class="lang-Text" data-author-content="traceroute to public.kzffavtrkpeulburui2lgywxwg.gx.internal.cloudapp.net (10.0.0.4), 64 hops max
1   10.0.0.4  1.095ms  1.610ms  0.812ms
Connection to 52.173.21.188 closed.
">traceroute to public.kzffavtrkpeulburui2lgywxwg.gx.internal.cloudapp.net (10.0.0.4), 64 hops max
1   10.0.0.4  1.095ms  1.610ms  0.812ms
Connection to 52.173.21.188 closed.
</code></pre>
<p>
    The
    <strong>
     private
    </strong>
    VM is using default routes, and traffic is routed directly between the subnets.
   </p>
</li>
</ol>
<p>
  You've now configured routing between subnets to direct traffic from the public internet through the
  <strong>
   dmzsubnet
  </strong>
  subnet before it reaches the private subnet. In the
  <strong>
   dmzsubnet
  </strong>
  subnet, you added a VM that acts as an NVA. You can configure this NVA to detect potentially malicious requests and block them before they reach their intended targets.
 </p>
</div>
</div>
<div class="translation-placeholder">
<h2>ðŸ‡»ðŸ‡³ Vietnamese Translation</h2>
<p><em>Báº£n dá»‹ch tiáº¿ng Viá»‡t sáº½ Ä‘Æ°á»£c thÃªm vÃ o Ä‘Ã¢y...</em></p>
<p><em>Translation will be added here...</em></p>
</div>
</body>
</html>